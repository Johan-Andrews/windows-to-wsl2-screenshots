# True automatic clipboard monitor using Windows events
param(
    [string]$SaveDirectory = "\\wsl.localhost\Ubuntu-20.04\home\droopy\.clipboard"
)

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

if (!(Test-Path $SaveDirectory)) {
    New-Item -ItemType Directory -Path $SaveDirectory -Force | Out-Null
}

Write-Host "AUTO-CLIPBOARD MONITOR STARTED"
Write-Host "Auto-saving images to: $SaveDirectory"
Write-Host "Press Ctrl+C to stop"



Write-Host "Monitoring clipboard events and directory changes..."
$previousHash = $null
$lastFileTime = Get-Date

# Function to copy path to both clipboards
function Set-BothClipboards($path) {
    try {
        [System.Windows.Forms.Clipboard]::SetText($path)
        $wslCommand = "echo '$path' | clip.exe"
        wsl.exe -e bash -c $wslCommand
        return $true
    } catch {
        Start-Sleep -Milliseconds 200
        try {
            [System.Windows.Forms.Clipboard]::SetText($path)
            $wslCommand = "echo '$path' | clip.exe" 
            wsl.exe -e bash -c $wslCommand
            return $true
        } catch {
            Write-Warning "Could not set clipboard: $_"
            return $false
        }
    }
}

while ($true) {
    try {
        Start-Sleep -Milliseconds 500
        
        if ([System.Windows.Forms.Clipboard]::ContainsImage()) {
            $image = [System.Windows.Forms.Clipboard]::GetImage()
            if ($image) {
                $ms = New-Object System.IO.MemoryStream
                $image.Save($ms, [System.Drawing.Imaging.ImageFormat]::Png)
                $imageBytes = $ms.ToArray()
                $ms.Dispose()
                $currentHash = [System.BitConverter]::ToString([System.Security.Cryptography.SHA256]::Create().ComputeHash($imageBytes))
                
                if ($currentHash -ne $previousHash) {
                    Write-Host "New image detected in clipboard"
                    
                    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
                    $filename = "clipboard_$timestamp.png"
                    $filepath = Join-Path $SaveDirectory $filename
                    $image.Save($filepath, [System.Drawing.Imaging.ImageFormat]::Png)
                    
                    $latestPath = Join-Path $SaveDirectory "latest.png"
                    if (Test-Path $latestPath) { Remove-Item $latestPath -Force }
                    Copy-Item $filepath $latestPath -Force
                    
                    $relativePath = "~/.clipboard/$filename"
                    Start-Sleep -Milliseconds 1000
                    
                    if (Set-BothClipboards $relativePath) {
                        Write-Host "AUTO-SAVED: $filename"
                        Write-Host "Path ready for Ctrl+V: $relativePath"
                    }
                    
                    $previousHash = $currentHash
                }
                $image.Dispose()
            }
        }
        
        # Also check for new files in the directory (for drag-drop screenshots)
        $currentTime = Get-Date
        $newFiles = Get-ChildItem $SaveDirectory -Filter "*.png" | Where-Object { 
            $_.LastWriteTime -gt $lastFileTime -and $_.Name -ne "latest.png" 
        }
        
        if ($newFiles) {
            foreach ($file in $newFiles) {
                $relativePath = "~/.clipboard/$($file.Name)"
                Copy-Item $file.FullName (Join-Path $SaveDirectory "latest.png") -Force
                
                if (Set-BothClipboards $relativePath) {
                    Write-Host "NEW FILE DETECTED: $($file.Name)"
                    Write-Host "Path ready for Ctrl+V: $relativePath"
                }
            }
            $lastFileTime = $currentTime
        }
        
    } catch {
        Write-Warning "Error in main loop: $_"
        Start-Sleep -Milliseconds 1000
    }
}
